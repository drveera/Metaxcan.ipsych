#!/bin/make

#calculate the covariance
$(outname).covariance.matrix.gz:$(outname).dosage.gz
	Rscript $(sd)/calculate.covariance.new.R $(outname).weights.csv $(outname).dosage.gz $(outname).covariance.matrix
	gzip $(outname).covariance.matrix 

# format in to predixcan
#predixcan file
$(outname).dosage.gz:$(outname).first5columns $(outname).maf $(outname).gen.traw
	cut -f 7- $(outname).gen.traw > $(outname).doses
	paste $(outname).first5columns $(outname).maf $(outname).doses | sed 1d > $(outname).dosage
	gzip $(outname).dosage

# first 5 columns
$(outname).first5columns:$(outname).gen.traw
	awk '{print "chr" $$1 "\t" $$2 "\t" $$4 "\t" $$6 "\t" $$5}' $(outname).gen.traw > $(outname).first5columns 
# maf column
$(outname).maf:$(outname).frq
	awk '{print $$5}' $(outname).frq | sed 1d > $(outname).maf 

# calculate allele frequencies
$(outname).frq:$(outname).gen.traw $(outname).mismatch.removed.bim
	plink --bfile $(outname).mismatch.removed \
--freq --out $(outname)

# write recode A-transpose format
$(outname).gen.traw:$(outname).mismatch.removed.bim $(outname).snps.not.extracted $(outname).rsids.mismatch.verify
	plink --bfile $(outname).mismatch.removed \
--recode A-transpose tab \
--out $(outname).gen
